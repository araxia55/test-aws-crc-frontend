name: Build & Deploy Test AWS CRC Terraform Infrastructure ğŸ—ï¸

run-name: ${{ github.actor }} has pushed changes to ${{ github.event.ref }}

on:
  push:
    branches:
      - main
      - 'release/infra/*'

jobs:

    build_and_deploy_infra:
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: ./infra
        
        steps:
          - name: Checkout â˜‘ï¸
            uses: actions/checkout@v4
    
          - name: Configure AWS Credentials ğŸ”
            uses: aws-actions/configure-aws-credentials@v1
            with:
              aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
              aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              aws-region: us-east-1
        
          - name: Setup Terraform ğŸ› ï¸
            uses: hashicorp/setup-terraform@v3
            with:
                terraform_version: 'latest'
        
          - name: Terraform Init â¬†ï¸
            id: init
            run: terraform init

          - name: Terraform Validate âœ…
            id: validate
            run: terraform validate

          - name: Terraform Plan âœ…
            id: plan
            run: terraform plan
            continue-on-error: true

          - name: Terraform Apply âœ…
            id: apply
            run: terraform apply -auto-approve 

    Scan_Terraform_with_tfsec:
      name: tfsec sarif report ğŸ”
      runs-on: ubuntu-latest
      needs: build_and_deploy_infra
      permissions:
        actions: read
        contents: read
        security-events: write
  
      steps:
        - name: Clone repo ğŸ”„
          uses: actions/checkout@master
  
        - name: Run tfsec ğŸ”
          uses: aquasecurity/tfsec-sarif-action@v0.1.4
          with:
            sarif_file: tfsec.sarif
  
        - name: Upload SARIF file â¬†ï¸
          uses: github/codeql-action/upload-sarif@v3
          with:
            # Path to SARIF file relative to the root of the repository
            sarif_file: tfsec.sarif    